# BGP
_ _  _
**BGP** (англ. Border Gateway Protocol, протокол граничного шлюза) — дистанционно векторный протокол динамической маршрутизации. Протокол BGP предназначен для обмена информацией о достижимости подсетей между автономными системами (АС, англ. AS — autonomous system), то есть группами маршрутизаторов под единым техническим и административным управлением.   

__Основные термины__
- Анонс - маршрут, отправленный в сообщении UPDATE
- Префикс - адрес и маска подсети, анонсируемые соседям в сообщении UPDATE
- Атрибуты - параметры маршрута, которые передаются вместе с ним в сообщении UPDATE
- Full-view - совокупность всех используемых публичных ASN и сетей (~900 000 префиксов)

**BGP** не обнаруживает соседей автоматически – каждый сосед настраивается вручную.Процесс установления отношений соседства происходит следующим образом:
1. **IDLE** - значальное состояние BGP-соседства – IDLE. Ничего не происходит. BGP находится в соcтоянии IDLE, если нет маршрута к BGP-соседу.
2. **ACTIV/CONNECT** - Для обеспечения надёжности BGP использует TCP. BGP-маршрутизатор (их также называют BGP-спикерами/speaker или BGP-ораторами) слушает и посылает пакеты на 179-й TCP порт.
 - CONNECT - это состояние когда слушает
 - ACTIVE - это состояние когда отправил и ожидает ответа от соседа

В состоянии ACTIVE BGP может подвиснуть, если:
- нет IP-связности с R2
- BGP не запущен на R2
- порт 179 закрыт ACL

3. **OPEN** - после того, как TCP-сессия установлена, BGP-ораторы начинают обмен сообщениями. OPEN – первый тип сообщений BGP. Они отсылаются только в самом начале BGP-сессии для согласования параметров. В нём передаются версия протокола, номер AS, Hold Timer и Router ID. Чтобы BGP-сессия поднялась, должны соблюдаться следующие условия:
- версии протокола должна быть одинаковой
- Номера AS в сообщении OPEN должны совпадать с настройками на удалённой стороне
- Router ID должны различаться

Когда сообщение Open отправлено – это состояние **OPEN** **SENT.**    
Когда оно получено – это сотояние **OPEN** **CONFIRM.**    

  Получив OPEN от R1, R2 отправляет свой OPEN, а также KEEPALIVE, говорящий о том, что OPEN от R1 получен – это сигнал для R1 переходить к следующему состоянию – Established.

4. **ESTABLISHED** - псле всех  шагов выше они переходят в стабильное состояние

  Для обмена маршрутной информации маршрутизаторы отсылают сообщения **UPDATE**. Каждое сообщение UPDATE может нести информацию об одном новом маршруте или о удалении группы старых. Причём одновременно.    
  **UPDATE** передаются при каждом изменении в сети до тех пор пока длится BGP-сессия   
  <p align="center">
<image src="https://github.com/LLlMEJIb87/OTUS-learning/blob/master/BGP/Picture/BGP_UPDATE.PNG">
</p>    

R1 передаёт маршрутную информацию на R2.     
**NLRI** – Network Layer Reachability Information  - информация о маршрутах      
**AS_PATH** означает, что маршрут пришёл из AS с номером 100.    
**NEXT_HOP** – что логично, информация для R2, что указывать в качестве шлюза для данного маршрута.    
**ORIGIN** сообщает о происхождении маршрута:
- IGP – задан вручную командой network или получен по BGP !!!!!!!!!!!!!!!!
- Incomplete*– чаще всего означает, что маршрут получен через редистрибьюцию        

5. **KEEPALIVE** - каждый BGP-маршрутизатор регулярно будет рассылать сообщения KEEPALIVE. Как и в любом другом протоколе это означает: «Я всё ещё жив». Это происходит с истечением таймера Keepalive – по умолчанию 60 секунд.
   

## Выбор маршрута  
BGP анонсирует не все приходящие маршруты, а только лучшие. То есть от одного соседа вы никогда не получите два маршрута в одну сеть.       

__Что влияет на выбор маршрута в BGP__
- Известные обязательные (wellknown, mandatory): должны распознаваться всеми реализациями протокола BGP и всегда присутствовать в сообщении UPDATE: __AS-PATH; NEXT-HOP; ORIGIN;__
- Известные необязательные (wellknown, discretionary): должны распознаваться всеми реализациями протокола BGP, но не всегда присутствуют в сообщении UPDATE: __LOCAL PREFERENCE; ATOMIC AGGREGATE;__
- Опциональные транзитивные (optional, transitive): необязательные атрибуты, передаются за пределы AS:  __AGGREGATOR; COMMUNITY;__
- Опциональный нетранзитивный (optional, non-transitive): необязательный атрибут, не передается за пределы AS: __MED__

__Критерии выбора лучших:__
1. Максимальное значение Local Preference (для всей AS)
2. Предпочесть локальный маршрут маршрутизатора (next hop = 0.0.0.0)
3. Кратчайший путь через автономные системы. (самый короткий AS_PATH)
4. Минимальное значение Origin Code (IGP)
5. Минимальное значение MED (распространяется между автономными системами)
6. Путь eBGP лучше чем путь iBGP
7. Выбрать путь через ближайшего IGP-соседа:    
Если это условие выполнено, то происходит балансировка нагрузки между несколькими равнозначными линками     

__Следующие условия могут различаться от вендора к вендору:__
8. Выбрать самый старый маршрут для eBGP-пути
9. Выбрать путь через соседа с наименьшим BGP router ID
10. Выбрать путь через соседа с наименьшим IP-адресом      


### Атрибуты
__AS-Path__     
Маршрут в BGP представляет из себя список AS, иначе называемый AS-Path.   

__AS-path__ формируется следующим образом:   
1. Как только маршрутизатор анонсирует маршрут своему внешнему соседу, он добавляет в список AS-path номер своей AS.
2. Внутри соседской AS, список не меняется и содержит только номер изначальной AS
3. Когда из соседской AS маршрут передаётся дальше в начало списка добавляется номер текущей AS.
4. И так далее. При передаче маршрута внешнему соседу номер AS всегда добавляется в начало списка AS-path. То есть фактически это стек.

AS-path нужен не просто для того, чтобы маршрутизатор R1 знал путь до конечной сети – ведь по сути Next Hop достаточно – каждый маршрутизатор решение по-прежнему принимает на основе таблицы маршрутизации. На самом деле тут преследуются две более важные цели:
1. Предотвращение петель маршрутизации. В AS-Path не должно быть повторяющихся номеров
- На самом деле ASN может повторяться в AS-Path в двух случаях    
а)  Когда  используем AS-Path Prepend    
б) Когда  хотим соединить два куска одной AS
2. Выбор наилучшего маршрута. Чем короче AS-Path, тем предпочтительнее маршрут      

__NEXT-HOP__    
IP-адрес следующего маршрутизатора по пути в сеть назначения (Не перезаписывается в пределах AS при передаче iBGP-соседям)  

__ORIGIN (Источник маршрута):__
- i – IGP (получен от маршрутизатора в своей AS)
- e – EGP (получен от маршрутизатора из другой AS)
- ? – Incomplete (перераспределен в BGP из другого источника)


__LOCAL PREFERENCE__     
Локальное предпочтение принимаемых маршрутов на роутере. Используется для управления исходящим трафиком из AS. Чем выше установленное значени LP тем более предпочтительный маршрут не смотря на более длинный AS-Path. Таким образом мы можем  устанавливать предпочтение ИСХОДЯЩЕГО маршрута     

__COMMUNITY__    
Механизм маркировки маршрутов для дальнейшей обработки и управления трафиком    

__MED (Multi Exit Discriminator)__     
Предпочитаемая точка входа в AS. Способ влияния на маршрутизаторы из другой автономной системы

## Инструменты работы с BGP
1. Через сайт stat.ripe.net можно посмотреть какие провайдеры обеспечивают транзит.
2. Looking Glass -Это сервера, расположенные в Интернете, которые позволяют взглянуть на сеть извне: проверить доступность, просмотреть через какие AS лежит путь в вашу автономную систему, запустить трассировку до своих внутренних адресов.
- http://www.traceroute.org/#Looking%20Glass
- https://www.bgp4.as/looking-glasses/
3. BGPPlay https://stat.ripe.net/widget/bgplay  -  это утилита, которая позволяет визуализировать информацию о распространении и удалении маршрутов BGP.    
   http://xgu.ru/wiki/BGPlay

  

